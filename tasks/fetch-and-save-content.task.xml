<task id="bmad/sew/tasks/fetch-and-save-content.task.xml" name="Fetch and Save Content">
  <objective>Trích xuất nguyên bản nội dung từ URL và lưu vào Markdown mà không dịch, không viết lại, không tóm tắt.</objective>

  <llm critical="true">
    <mandate>YOU MUST READ {project-root}/bmad/sew/tools/firecrawl-prompts.yaml using Read tool BEFORE executing step 3</mandate>
    <mandate>Parse the YAML content to extract domain-specific prompt matching the URL's domain</mandate>
    <mandate>If no domain match found, use the "default" key value from YAML</mandate>
    <mandate>The prompt from YAML must be passed to scrape-url tool via --prompt flag</mandate>
  </llm>

  <parameters>
    <param name="url" type="string" required="true">Đường dẫn bài viết cần trích xuất.</param>
    <param name="output_file" type="string" required="false">Đường dẫn file output (mặc định: {sessions_output_folder}/fetched-content-{timestamp}.md).</param>
    <param name="sessions_output_folder" type="string" required="false">Thư mục lưu sessions (đọc từ config).</param>
  </parameters>

  <output>
    <param name="content" type="string">Nội dung Markdown gốc sau khi trích xuất.</param>
    <param name="output_path" type="string">File đích đã lưu.</param>
    <param name="success" type="boolean">Trạng thái thành công/thất bại.</param>
  </output>

  <flow>
    <step n="1" goal="Xác định đường dẫn output">
      <action>
        Nếu {{output_file}} đã được cung cấp thì sử dụng trực tiếp.
        Nếu chưa, tạo tên file theo timestamp: fetched-content-{YYYY-MM-DD-HHmmss}.md và ghép vào {{sessions_output_folder}}.
      </action>
      <action>Store output path as {{final_output_path}}</action>
    </step>

    <step n="2" goal="Load và chọn domain-specific prompt từ firecrawl-prompts.yaml">
      <critical>Phải giữ nguyên ngôn ngữ và nội dung gốc. Tuyệt đối không viết lại, không dịch, không tóm tắt.</critical>

      <action>Extract domain từ {{url}}:
        - Ví dụ: https://healthinaging.org/article/123 → domain = "healthinaging.org"
        - Ví dụ: https://www.example.com/blog/post → domain = "example.com" (bỏ www.)
        - Lưu vào {{extracted_domain}}
      </action>

      <action critical="true">
        USE Read tool to load {project-root}/bmad/sew/tools/firecrawl-prompts.yaml
        - This step is MANDATORY, not optional
        - Store the YAML content for parsing
      </action>

      <action>Parse YAML content to find matching prompt:
        STEP 1: Look for exact domain match (e.g., "healthinaging.org")
        STEP 2: If not found, look for "default" key
        STEP 3: If "default" not found or empty, use empty string ""

        Example YAML structure:
        ```yaml
        default: ""
        healthinaging.org: |
          Instruction for this domain...
        ```

        Store matched value in {{firecrawl_prompt}}
      </action>

      <action>Construct the prompt flag for scrape-url command:
        IF {{firecrawl_prompt}} is not empty:
          {{prompt_flag}} = --prompt "{{firecrawl_prompt}}"
        ELSE:
          {{prompt_flag}} = "" (empty string, no flag)
      </action>

      <action>Log for debugging:
        - "Domain extracted: {{extracted_domain}}"
        - "Prompt found: {{firecrawl_prompt}}" (show first 100 chars if long)
        - "Using flag: {{prompt_flag}}"
      </action>
    </step>

    <step n="3" goal="Trích xuất nội dung gốc bằng FireCrawl MCP">
      <action>Execute Firecrawl scraping via MCP (preferred) or CLI (fallback).</action>

      <action critical="true">
        OPTION A - Use Firecrawl MCP (PREFERRED):

        Check if Firecrawl MCP tool is available (tool name patterns: mcp__firecrawl__scrape, mcp_firecrawl_scrape, or similar).

        IF MCP tool is available:
          Call the MCP tool directly with parameters:
          - url: {{url}}
          - formats: ["markdown"]
          - prompt: {{firecrawl_prompt}} (if not empty, this is the extraction instruction)

          Example call structure:
          ```
          Tool: mcp__firecrawl__scrape
          Parameters:
            url: "https://healthinaging.org/article/123"
            formats: ["markdown"]
            prompt: "Mỗi menu item bên trong Left Sidebar..."  (if domain has instruction)
          ```

          Store result as {{raw_content}}
      </action>

      <action>
        OPTION B - Fallback to CLI (if MCP not available):

        Use Bash tool to run firecrawl CLI command:
        - Construct prompt flag: {{prompt_flag}} = --prompt "{{firecrawl_prompt}}" if prompt not empty, else ""
        - Execute: firecrawl scrape {{url}} {{prompt_flag}}
        - Store output as {{raw_content}}

        Note: This requires FIRECRAWL_API_KEY environment variable
      </action>

      <action>
        Log which method was used:
        - "Using Firecrawl MCP tool" OR "Fallback to Firecrawl CLI"
        - Include URL and whether prompt was applied
      </action>

      <note>MCP is strongly preferred as it handles parameters better and is more reliable than CLI</note>
      <note>The scrape-url tool definition is in {project-root}/bmad/sew/tools/scrape-url.tool.yaml</note>
    </step>

    <step n="4" goal="Kiểm tra và làm sạch Markdown">
      <action>Kiểm tra {{raw_content}} hợp lệ. Nếu rỗng hoặc lỗi, trả về thất bại.</action>
      <check if="{{raw_content}} is empty or error">
        <action>Set {{success}} = false</action>
        <action>Set {{error_message}} = "Không thể trích xuất nội dung từ URL: {{url}}"</action>
        <output>
          <param name="success" type="boolean">false</param>
          <param name="error_message" type="string">{{error_message}}</param>
        </output>
        <goto step="999"/>
      </check>
      <action>
        Làm sạch nhẹ nhàng: đảm bảo heading, list đúng chuẩn Markdown nhưng không thay đổi câu chữ, không thêm bình luận.
      </action>
      <action>Store cleaned content as {{cleaned_content}}</action>
    </step>

    <step n="5" goal="Thêm metadata vào đầu file">
      <action>
        Tạo header:
        ```
        ---
        source_url: {{url}}
        fetched_date: {current_timestamp}
        tool: scrape-url (firecrawl)
        ---

        # Nội dung từ: {{url}}

        {{cleaned_content}}
        ```
      </action>
      <action>Store final content as {{final_content}}</action>
    </step>

    <step n="6" goal="Lưu file kết quả">
      <action>Tạo thư mục {{sessions_output_folder}} nếu chưa tồn tại.</action>
      <action>Ghi {{final_content}} vào {{final_output_path}} và xác nhận thành công.</action>
    </step>

    <step n="7" goal="Trả kết quả">
      <output>
        <param name="content" type="string">{{final_content}}</param>
        <param name="output_path" type="string">{{final_output_path}}</param>
        <param name="success" type="boolean">true</param>
        <param name="message" type="string">Đã trích xuất và lưu nội dung gốc vào: {{final_output_path}}</param>
      </output>
    </step>

    <step n="999" goal="Error exit point"/>
  </flow>

  <notes>
    <note>firecrawl-cli cần được cài đặt và cấu hình FIRECRAWL_API_KEY.</note>
    <note>Domain-specific prompts: {project-root}/bmad/sew/tools/firecrawl-prompts.yaml
      - Format: YAML với keys là domain names (e.g., "healthinaging.org")
      - Mỗi domain có thể có instruction riêng về cách extract content
      - Key "default" sẽ được dùng nếu không có domain match
      - Nếu "default" cũng rỗng, firecrawl sẽ chạy ở chế độ chuẩn (auto-extract)
    </note>
    <note>Để thêm instruction cho domain mới, edit firecrawl-prompts.yaml:
      ```yaml
      domain.com: |
        Your extraction instruction here.
        Can be multiline.
      ```
    </note>
    <note>The Read tool MUST be used to load prompts file - this is enforced by mandate at task level.</note>
  </notes>
</task>
